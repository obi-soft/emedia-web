<!DOCTYPE html>
<html>
<head>
<title>Blogs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/style.css?v=3">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<div style="padding:16px;display:flex;align-items:center;justify-content:space-between">
  <h3>News</h3>
  <div>
    <button class="btn" onclick="location.href='news.html'">Create</button>
  </div>
</div>

<section style="padding:16px">
  <div id="postsList" style="display:grid;gap:12px"></div>
</section>

<div class="bottom-nav">
  <button type="button" class="nav-item" onclick="location.href='home.html'"><span class="material-icons">home</span><span>Home</span></button>
  <button type="button" class="nav-item" onclick="location.href='chat.html'"><span class="material-icons">chat</span><span>Chat</span></button>
  <button type="button" class="nav-item" onclick="location.href='profile.html'"><span class="material-icons">person</span><span>Profile</span></button>
</div>

<script>
function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[c]); }
function getImageUrl(p){ return (p && (p.imageUrl||p.imageURL||p.image||'')) || ''; }
function formatDate(val){ if(!val) return ''; if(typeof val === 'number') return new Date(val).toLocaleString(); if(val && typeof val.toDate === 'function') return new Date(val.toDate()).toLocaleString(); return ''; }
function renderPosts(posts){
  const list = document.getElementById('postsList'); if(!list) return; list.innerHTML='';
  if(!posts || posts.length===0){ list.innerHTML = '<div class="muted">No posts yet</div>'; return; }
  posts.forEach(p=>{
    const el = document.createElement('div'); el.className = 'card';
    const imgUrl = getImageUrl(p);
    const img = imgUrl ? '<img src="'+imgUrl+'" style="width:100%;height:150px;object-fit:cover;border-radius:6px;margin-bottom:8px">' : '';
    const id = p.id || p._id || ('local-' + (p.createdAt || Date.now()));
    const date = formatDate(p.createdAt);
    el.innerHTML = '<a href="post.html?id='+encodeURIComponent(id)+'" style="color:inherit;text-decoration:none;display:block">' + img + '<div style="font-weight:600">' + escapeHtml(p.title||'Untitled') + '</div><div class="muted" style="font-size:13px">' + escapeHtml(p.body||'') + '</div><div class="muted" style="font-size:12px;margin-top:6px">' + date + '</div></a>';
    list.appendChild(el);
  });
}

(async function(){
  try{
    const cfg = window.FIREBASE_CONFIG || {};
    if(cfg && cfg.apiKey && cfg.apiKey !== 'REPLACE_ME'){
      const [{ initializeApp }, { getFirestore, collection, query, orderBy, limit, onSnapshot } ] = await Promise.all([
        import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js')
      ]);
      const app = initializeApp(cfg);
      const db = getFirestore(app);
      const q = query(collection(db,'posts'), orderBy('createdAt','desc'), limit(50));
      onSnapshot(q, snap=>{
        const arr = [];
        snap.forEach(doc=> arr.push(Object.assign({ id: doc.id }, doc.data())));
        renderPosts(arr);
      });
      return;
    }
  }catch(e){ console.warn(e); }

  try{ const raw = localStorage.getItem('posts'); const posts = raw?JSON.parse(raw):[]; renderPosts(posts.reverse()); }catch(e){ console.warn(e); }
})();
</script>
</body>
</html>