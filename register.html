<!DOCTYPE html>
<html>
<head>
<title>Register</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="css/style.css?v=2">
</head>
<body class="app-bg">


<div class="auth-card">
  <div class="app-brand">
    <!-- inline SVG logo (guaranteed to display) -->
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="2" y="3" width="20" height="14" rx="3" fill="#1976d2"/>
      <path d="M4 17c0 1.1.9 2 2 2h12v1a1 1 0 0 1-1 1H5a2 2 0 0 1-1-3.732V17z" fill="#0b3a66"/>
      <circle cx="17.5" cy="6.5" r="1.5" fill="#fff"/>
    </svg>
    <span>eMedia</span>
  </div>
  <h2>Create account</h2>
  <div class="input-group"><span class="material-icons">person</span><input type="text" id="username" placeholder="Username"></div>
  <div class="input-group"><span class="material-icons">email</span><input type="email" id="email" placeholder="Email"></div>
  <div class="input-group"><span class="material-icons">lock</span><input type="password" id="password" placeholder="Password"></div>

  <!-- News-related fields -->
  <label class="muted">Preferred categories</label>
  <div class="checkbox-group">
    <label><input type="checkbox" name="categories" value="Politics"> Politics</label>
    <label><input type="checkbox" name="categories" value="Technology"> Technology</label>
    <label><input type="checkbox" name="categories" value="Sports"> Sports</label>
    <label><input type="checkbox" name="categories" value="Entertainment"> Entertainment</label>
    <label><input type="checkbox" name="categories" value="Business"> Business</label>
    <label><input type="checkbox" name="categories" value="Science"> Science</label>
  </div>

  <div class="input-group"><span class="material-icons">place</span><input type="text" id="location" placeholder="Location (city/country)"></div>
  <div class="input-group"><span class="material-icons">business</span><input type="text" id="organization" placeholder="Organization (optional)"></div>
  <div class="input-group"><span class="material-icons">description</span><textarea id="bio" placeholder="Short bio / interests" rows="3" style="resize:none;border:0;background:transparent;width:100%"></textarea></div>

  <div style="display:flex;align-items:center;gap:8px;margin:8px 0">
    <input type="checkbox" id="newsletter"><label for="newsletter" class="muted"> Subscribe to newsletter</label>
  </div>

  <div class="input-group"><span class="material-icons">photo_camera</span><input type="file" id="avatar" accept="image/*"></div>
  <img id="avatarPreview" class="avatar-preview" src="" alt="" style="display:none">
  <div style="font-size:12px;color:#667789;margin-top:6px">Avatar is optional. Leave blank to use default icon.</div>

  <button class="btn primary" onclick="register()">Register</button>
  <p class="muted">Already a member? <a href="index.html">Login</a></p>
</div>


<!-- loading overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none">
  <div class="spinner"></div>
  <div>Creating account...</div>
</div>

<script type="module" src="js/auth.js?v=2"></script>
<script>
// if user already logged in, redirect to home
(function(){
  try{ if(localStorage.getItem('user')||localStorage.getItem('token')){ window.location.href='home.html'; }}catch(e){}
})();

// preview avatar
const avatarInput = document.getElementById('avatar');
const avatarPreview = document.getElementById('avatarPreview');
if(avatarInput){
  avatarInput.addEventListener('change', function(){
    const f = avatarInput.files && avatarInput.files[0];
    if(!f){ avatarPreview.style.display='none'; avatarPreview.src=''; return; }
    const url = URL.createObjectURL(f);
    avatarPreview.src = url; avatarPreview.style.display='block';
  });
}

function setLoading(show){
  const overlay = document.getElementById('loadingOverlay');
  const btn = document.querySelector('.btn.primary');
  if(overlay) overlay.style.display = show ? 'flex' : 'none';
  if(btn) btn.disabled = !!show;
}

// collect form values into an object
function collectUserData(){
  const username = document.getElementById('username')?.value || '';
  const email = document.getElementById('email')?.value || '';
  const password = document.getElementById('password')?.value || '';
  const location = document.getElementById('location')?.value || '';
  const organization = document.getElementById('organization')?.value || '';
  const bio = document.getElementById('bio')?.value || '';
  const newsletter = !!document.getElementById('newsletter')?.checked;
  const categories = Array.from(document.querySelectorAll('input[name="categories"]:checked')).map(n=>n.value);
  const avatarInput = document.getElementById('avatar');

  let avatarFileName = '';
  if(avatarInput && avatarInput.files && avatarInput.files[0]){
    avatarFileName = avatarInput.files[0].name;
  }

  return { username, email, password, location, organization, bio, newsletter, categories, avatarFileName };
}

// wrapper that calls existing register() and then redirects on success
async function doRegister(){
  const userData = collectUserData();

  // basic validation
  if(!userData.email || !userData.password){
    alert('Please provide email and password');
    return;
  }

  setLoading(true);

  try{
    // If register accepts data, call with it
    if(typeof register === 'function'){
      try{
        const result = register(userData);
        if(result && typeof result.then === 'function'){
          await result;
        }
      }catch(e){
        // fallback to calling without args
        try{ const r2 = register(); if(r2 && r2.then) await r2;}catch(e){}
      }
    }
  }catch(e){/* ignore */}

  // fallback: save basic profile locally if register didn't store it
  try{
    if(!localStorage.getItem('user')){
      const saved = Object.assign({}, userData);
      delete saved.password; // do not store raw password
      localStorage.setItem('user', JSON.stringify(saved));
      localStorage.setItem('token', 'local-' + Date.now());
    }
  }catch(e){}

  // small delay so user sees loading state
  setTimeout(()=>{
    setLoading(false);
    window.location.href = 'home.html';
  },800);
}

// replace onclick on button to new handler
var btn = document.querySelector('.btn.primary'); if(btn) btn.setAttribute('onclick','doRegister()');
</script>
</body>
</html>