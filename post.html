<!DOCTYPE html>
<html>
<head>
<title>Post</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/style.css?v=3">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<div style="padding:16px;">
  <button class="btn" onclick="location.href='blogs.html'">Back</button>
</div>

<main style="padding:16px;max-width:800px;margin:0 auto">
  <h1 id="postTitle">Loading...</h1>
  <div id="postMeta" class="muted" style="margin-bottom:12px"></div>
  <div id="postImageContainer"></div>
  <div id="postBody" style="margin-top:12px"></div>
  <div id="postTags" style="margin-top:12px;color:#667"></div>
</main>

<script>
function getQueryParam(name){ const p = new URLSearchParams(window.location.search); return p.get(name); }
function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[c]); }
function getImageUrl(obj){ return (obj && (obj.imageUrl||obj.imageURL||obj.image||'')) || ''; }

(async function(){
  const id = getQueryParam('id');
  if(!id){ document.getElementById('postTitle').innerText = 'Post not found'; return; }

  // create related container
  const relatedContainer = document.createElement('section'); relatedContainer.id = 'relatedPosts'; relatedContainer.style = 'padding:16px;max-width:800px;margin:16px auto';
  relatedContainer.innerHTML = '<h3>Related posts</h3><div id="relatedList" style="display:grid;grid-template-columns:1fr 1fr;gap:12px"></div>';
  document.body.appendChild(relatedContainer);

  // try firebase first
  try{
    const cfg = window.FIREBASE_CONFIG || {};
    if(cfg && cfg.apiKey && cfg.apiKey !== 'REPLACE_ME'){
      const [{ initializeApp }, firestoreModule ] = await Promise.all([
        import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'),
        import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js')
      ]);
      const { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, limit } = firestoreModule;
      const app = initializeApp(cfg);
      const db = getFirestore(app);
      // try to fetch by doc id
      try{
        const dref = doc(db, 'posts', id);
        const snap = await getDoc(dref);
        if(snap && snap.exists()){
          const data = snap.data();
          document.getElementById('postTitle').innerText = data.title || 'Untitled';
          document.getElementById('postBody').innerHTML = escapeHtml(data.body || '');
          const imageUrl = getImageUrl(data);
          if(imageUrl) document.getElementById('postImageContainer').innerHTML = `<img src="${imageUrl}" style="width:100%;max-height:420px;object-fit:cover;border-radius:6px">`;
          if(data.tags && data.tags.length) document.getElementById('postTags').innerText = 'Tags: ' + data.tags.join(', ');
          document.getElementById('postMeta').innerText = data.author || '';

          // load related posts (fetch recent and then filter)
          try{
            const q = query(collection(db,'posts'), orderBy('createdAt','desc'), limit(20));
            const snap2 = await getDocs(q);
            const arr = [];
            snap2.forEach(d=> arr.push(Object.assign({ id: d.id }, d.data())));
            const related = findRelated(arr, id, data.tags);
            renderRelated(related);
          }catch(e){ console.warn('related fetch failed', e); }
          return;
        }
      }catch(e){/* ignore */}
    }
  }catch(e){ console.warn(e); }

  // fallback: search localStorage posts by id or last segment
  try{
    const raw = localStorage.getItem('posts');
    const posts = raw ? JSON.parse(raw) : [];
    const found = posts.find(p => p.id === id || p._id === id || ('local-' + (p.createdAt || '') + '-0') === id);
    if(found){
      document.getElementById('postTitle').innerText = found.title || 'Untitled';
      document.getElementById('postBody').innerHTML = escapeHtml(found.body || '');
      const imageUrl = getImageUrl(found);
      if(imageUrl) document.getElementById('postImageContainer').innerHTML = `<img src="${imageUrl}" style="width:100%;max-height:420px;object-fit:cover;border-radius:6px">`;
      if(found.tags && found.tags.length) document.getElementById('postTags').innerText = 'Tags: ' + found.tags.join(', ');
      document.getElementById('postMeta').innerText = found.author || '';

      // related from local posts
      const related = findRelated(posts, id, found.tags);
      renderRelated(related);
      return;
    }
  }catch(e){ console.warn(e); }

  document.getElementById('postTitle').innerText = 'Post not found';

  // helper: find up to 2 related posts by shared tags or most recent
  function findRelated(items, currentId, tags){
    if(!items || items.length===0) return [];
    const filtered = items.filter(it => (it.id || it._id || ('local-'+(it.createdAt||''))) !== currentId);
    if(tags && tags.length){
      const byTag = filtered.filter(it => (it.tags||[]).some(t => tags.indexOf(t) !== -1));
      if(byTag.length >= 2) return byTag.slice(0,2);
      if(byTag.length > 0) return byTag.slice(0,2);
    }
    // fallback: most recent
    return filtered.slice(0,2);
  }

  function renderRelated(list){
    const container = document.getElementById('relatedList');
    if(!container) return;
    container.innerHTML = '';
    if(!list || list.length===0){ container.innerHTML = '<div class="muted">No related posts</div>'; return; }
    list.forEach(p=>{
      const id = p.id || p._id || ('local-' + (p.createdAt || Date.now()));
      const a = document.createElement('a');
      a.href = 'post.html?id=' + encodeURIComponent(id);
      a.style = 'display:block;color:inherit;text-decoration:none;border-radius:6px;padding:8px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,0.04);height:100%';
      const img = getImageUrl(p) ? `<img src="${getImageUrl(p)}" style="width:100%;height:80px;object-fit:cover;border-radius:4px;margin-bottom:6px">` : '';
      const title = `<div style="font-weight:600">${escapeHtml(p.title||'Untitled')}</div>`;
      const meta = `<div class="muted" style="font-size:12px">${p.author||''}</div>`;
      a.innerHTML = img + title + meta;
      const wrap = document.createElement('div'); wrap.style = 'min-height:120px'; wrap.appendChild(a); container.appendChild(wrap);
    });
  }
})();
</script>
</body>
</html>